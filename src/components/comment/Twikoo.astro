---
import { commentConfig } from "@/config";

interface Props {
	path: string;
}

const config = {
	...commentConfig.twikoo,
	el: "#tcomment",
	path: Astro.props.path,
};
---

<div id="tcomment"></div>
<script define:vars={{ config }}>
  function updateTwikooStats() {
    if (typeof twikoo === 'undefined') return;
    
    const path = getNormalizedPath();
    
    twikoo.getVisitCount({
      url: path,
      domId: 'twikoo_visitors'
    }).catch(console.error);
    
    twikoo.getCommentsCount({
      urls: [commentPath],
      includeReply: false
    }).then(res => {
      if (Array.isArray(res) && res.length > 0) {
        const currentPage = res.find(item => item.url === path);
        if (currentPage) {
          const commentsEl = document.getElementById('twikoo_comments');
          if (commentsEl) commentsEl.textContent = currentPage.count || 0;
        }
      }
    }).catch(console.error);
  }

  function loadTwikoo() {
    const script = document.createElement("script");
    script.src = "https://s4.zstatic.net/npm/twikoo@1.6.44/dist/twikoo.min.js";
    script.defer = true;
    script.onload = () => {
      twikoo.init({
        ...config,
        onCommentLoaded: () => {
          updateTwikooStats();
        }
      });
      
      updateTwikooStats();
    };
    document.body.appendChild(script);
  }

  document.addEventListener("loadComment", loadTwikoo, { once: true });
  
  const cacheKey = `twikoo_stats_${getNormalizedPath()}`;
  const cachedStats = sessionStorage.getItem(cacheKey);
  
  if (cachedStats) {
    const { views, comments } = JSON.parse(cachedStats);
    const visitorsEl = document.getElementById('twikoo_visitors');
    const commentsEl = document.getElementById('twikoo_comments');
    
    if (visitorsEl) visitorsEl.textContent = views;
    if (commentsEl) commentsEl.textContent = comments;
  }
  
  window.updateTwikooStats = updateTwikooStats;
  
  document.addEventListener('astro:after-swap', () => {

    sessionStorage.removeItem(cacheKey);
    
    updateTwikooStats();
  });
</script>